# 1-2 Letta Configuration Update for Unified Database

[Back to task list](./tasks.md)

## Description

Update Letta service configuration in docker-compose.yml to use the unified Supabase PostgreSQL database instead of the separate letta_db container, implementing the configuration-only migration strategy identified in Task 1-1.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-09-20 04:20:00 | Created | N/A | Proposed | Task created based on simplified migration approach | AI_Agent |
| 2025-09-20 04:20:00 | Status Update | Proposed | InProgress | Beginning Letta configuration update | AI_Agent |
| 2025-09-20 04:45:00 | Status Update | InProgress | Review | Configuration updated, Letta connected to unified database successfully | AI_Agent |

## Requirements

### Functional Requirements
- [ ] Update Letta environment variables to point to supabase-db
- [ ] Ensure Letta can connect to unified PostgreSQL database
- [ ] Preserve all existing Letta functionality
- [ ] Validate Letta health after configuration change
- [ ] Verify Letta creates tables in correct schemas

### Technical Requirements
- [ ] Access to docker-compose.yml for editing
- [ ] Ability to restart Letta service
- [ ] Network connectivity between Letta and supabase-db containers
- [ ] Postgres credentials for unified database

## Implementation Plan

### 1. Current Letta Configuration Analysis
```yaml
# Current configuration in docker-compose.yml
letta:
  environment:
    LETTA_PG_HOST: pgvector_db        # Points to letta_db container
    LETTA_PG_DB: letta               # Separate database
    LETTA_PG_USER: letta             # Separate user
    LETTA_PG_PASSWORD: letta         # Separate password
```

### 2. Target Configuration
```yaml
# New configuration for unified database
letta:
  environment:
    LETTA_PG_HOST: supabase-db       # Points to unified database
    LETTA_PG_DB: postgres            # Main postgres database
    LETTA_PG_USER: postgres          # Postgres superuser
    LETTA_PG_PASSWORD: ${POSTGRES_PASSWORD}  # Environment variable
```

### 3. Implementation Steps

#### Step 1: Backup Current Configuration
```bash
cp docker-compose.yml docker-compose.yml.backup
```

#### Step 2: Update Letta Environment Variables
```bash
# Edit docker-compose.yml
# Update LETTA_PG_HOST from 'pgvector_db' to 'supabase-db'
# Update LETTA_PG_DB from 'letta' to 'postgres'  
# Update LETTA_PG_USER from 'letta' to 'postgres'
# Update LETTA_PG_PASSWORD from 'letta' to '${POSTGRES_PASSWORD}'
```

#### Step 3: Test Configuration
```bash
# Stop current Letta service
docker compose stop letta

# Start Letta with new configuration
docker compose up letta -d

# Monitor startup logs
docker logs ai-pa-letta-1 --follow
```

#### Step 4: Validate Database Connection
```sql
-- Check that Letta creates tables in unified database
docker exec supabase-db psql -U postgres -d postgres -c "
SELECT schemaname, tablename 
FROM pg_tables 
WHERE schemaname IN ('letta_agents', 'letta_embeddings', 'public')
ORDER BY schemaname, tablename;
"
```

## Verification

### Success Criteria
- [ ] Letta service starts successfully with new configuration
- [ ] Letta health endpoint responds (http://localhost:8283/v1/health/)
- [ ] Letta creates database tables in unified PostgreSQL
- [ ] Letta functionality preserved (can create agents, handle requests)
- [ ] No errors in Letta service logs
- [ ] Other services (n8n, Supabase) remain unaffected

### Test Procedures

#### 1. Health Check Validation
```bash
# Test Letta health endpoint
curl -f http://localhost:8283/v1/health/
# Expected: 200 OK response
```

#### 2. Database Connection Validation
```bash
# Check Letta tables created in correct database
docker exec supabase-db psql -U postgres -d postgres -c "\dt public.*;"
docker exec supabase-db psql -U postgres -d postgres -c "\dt letta_*.*;"
```

#### 3. Basic Functionality Test
```bash
# Test basic Letta API functionality
curl -X GET http://localhost:8283/v1/agents/
# Expected: Valid JSON response (may be empty array initially)
```

#### 4. Log Analysis
```bash
# Check for database connection errors
docker logs ai-pa-letta-1 2>&1 | grep -i "error\|exception\|failed"
# Expected: No database connection errors
```

### Rollback Procedure
If issues are detected:
```bash
# Quick rollback
docker compose stop letta
cp docker-compose.yml.backup docker-compose.yml
docker compose up letta -d
```

## Files Modified

### Configuration Files
- `docker-compose.yml` - Letta service environment variables updated
- `docker-compose.yml.backup` - Backup of original configuration

### Documentation Files
- `docs/delivery/1/letta-config-changes.md` - Record of configuration changes made
- `docs/delivery/1/validation-results.md` - Results of post-change validation

---

[Back to task list](./tasks.md)
