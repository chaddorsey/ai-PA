# 2-1 Service Configuration Analysis and Standardization

[Back to task list](./tasks.md)

## Description

Analyze the current Docker Compose service configurations to identify inconsistencies, standardize naming patterns, environment variable usage, and optimize service definitions. Based on our prior analysis showing 90% integration already complete, focus on standardization rather than new integrations.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-09-20 05:00:00 | Created | N/A | Proposed | Task created based on simplified scope from Docker Compose analysis | AI_Agent |
| 2025-09-20 05:00:00 | Status Update | Proposed | InProgress | Beginning service configuration analysis | AI_Agent |
| 2025-09-20 05:30:00 | Status Update | InProgress | Review | Network unification complete - all 14 services on pa-internal network | AI_Agent |

## Requirements

### Functional Requirements
- [ ] Document current service configuration patterns and inconsistencies
- [ ] Standardize service naming conventions across all services
- [ ] Unify environment variable patterns and usage
- [ ] Standardize port mapping and exposure patterns
- [ ] Identify and resolve network configuration inconsistencies

### Technical Requirements
- [ ] Access to current docker-compose.yml for analysis
- [ ] Understanding of service interdependencies
- [ ] Knowledge of Docker Compose best practices
- [ ] Ability to test configuration changes incrementally

## Implementation Plan

### 1. Current Configuration Analysis

Based on our Docker Compose analysis, key inconsistencies identified:

#### Network Configuration Issues
```yaml
# Mixed network usage - needs unification
networks: [default]      # Most services
networks: [app-tier]     # slack-mcp-server only
# Missing: unified pa-network for all services
```

#### Service Naming Inconsistencies
```yaml
# Current naming patterns:
supabase-db         # kebab-case
graphiti-mcp        # kebab-case  
ai-pa-letta-1       # Generated with prefix
open-webui          # kebab-case
slack-mcp-server    # kebab-case with suffix
```

#### Port Mapping Patterns
```yaml
# Inconsistent port exposure:
ports: ["5678:5678"]      # n8n - direct mapping
ports: ["8283:8283"]      # letta - direct mapping  
ports: ["8800:8000"]      # graphiti-mcp - different external/internal
ports: ["7331:7331"]      # gmail - direct mapping
# Missing: standardized port allocation strategy
```

### 2. Standardization Strategy

#### A. Service Naming Convention
```yaml
# Target pattern: component-function
database:           supabase-db          # ✅ Already standard
ai-agent:           letta                # ✅ Already standard  
workflow:           n8n                  # ✅ Already standard
ui:                 open-webui           # ✅ Already standard
mcp-gmail:          gmail-mcp-server     # ✅ Already standard
mcp-slack:          slack-mcp-server     # ✅ Already standard
mcp-graphiti:       graphiti-mcp         # ✅ Already standard
knowledge-graph:    neo4j                # ✅ Already standard
tunnel:             cloudflared          # ✅ Already standard
```

#### B. Network Unification
```yaml
# Target: All services on pa-network
networks:
  pa-network:
    name: pa-internal
    driver: bridge
    
# All services updated to:
services:
  service-name:
    networks: [pa-network]
```

#### C. Environment Variable Patterns
```yaml
# Standardize patterns:
SERVICE_DEBUG: ${SERVICE_DEBUG:-false}
SERVICE_LOG_LEVEL: ${SERVICE_LOG_LEVEL:-INFO}
SERVICE_HOST: service-name
SERVICE_PORT: standard_port
```

### 3. Implementation Steps

#### Step 1: Network Standardization
```bash
# Add unified network definition
# Update all services to use pa-network
# Remove app-tier network usage
```

#### Step 2: Service Configuration Cleanup
```bash
# Standardize environment variable patterns
# Clean up unused configuration options
# Optimize volume mounts
```

#### Step 3: Health Check Standardization
```bash
# Add missing health checks
# Standardize health check patterns
# Optimize check intervals and timeouts
```

#### Step 4: Dependency Optimization
```bash
# Review and optimize depends_on relationships
# Ensure proper startup ordering
# Add condition: service_healthy where appropriate
```

## Verification

### Success Criteria
- [ ] All services use consistent naming patterns
- [ ] All services connected to unified pa-network
- [ ] Environment variables follow standard patterns
- [ ] Health checks implemented for all services
- [ ] Service dependencies properly configured
- [ ] No configuration redundancy or conflicts

### Test Procedures

#### 1. Configuration Validation
```bash
# Validate docker-compose.yml syntax
docker compose config

# Check for deprecated features
docker compose config --check
```

#### 2. Service Startup Testing
```bash
# Test clean startup
docker compose down
docker compose up -d

# Verify all services healthy
docker compose ps
```

#### 3. Network Connectivity Testing
```bash
# Test inter-service communication
docker exec letta curl -f http://supabase-db:5432
docker exec n8n curl -f http://supabase-db:5432
```

#### 4. Functionality Preservation Testing
```bash
# Test Letta API
curl -f http://localhost:8283/v1/health/

# Test n8n UI
curl -f http://localhost:5678

# Test Open WebUI
curl -f http://localhost:3000

# Test Supabase Studio
curl -f http://localhost:54323
```

## Files Modified

### Configuration Files
- `docker-compose.yml` - Main service configuration standardization
- `docker-compose.yml.backup` - Backup before changes

### Documentation Files
- `docs/delivery/2/service-analysis.md` - Detailed analysis of current configurations
- `docs/delivery/2/standardization-changes.md` - Record of standardization changes made
- `docs/delivery/2/network-migration-plan.md` - Network unification strategy

### Validation Scripts
- `scripts/validate-services.sh` - Service validation automation
- `scripts/test-connectivity.sh` - Inter-service connectivity testing

---

[Back to task list](./tasks.md)
